; Read PS/2 keyboard character and put it to the Memory Mapped XGA Screen
; This program requires a build of R32V2020 that has memory mapped video
; Example: R32V2020_Build_V002_A4_CE6_MMVid

prompt: .string "FakeTris 0.01"

start:
00000000	D400003B	bsr		clearScreen_mmXGA
00000001	42500000	lix		par,0				; start of screen
00000002	42600000	lix		dar,prompt.lower	; clear the data memory addr pointer
readDataMemory:
00000003	68806000	ldbp	r8					; get the character
00000004	39380000	cmpi	r8,0
00000005	D1000003	beq		doneWithPrompt
00000006	D4000042	bsr		putChar_mmXGA
00000007	C0FFFFFC	bra		readDataMemory
doneWithPrompt:
00000008	D4000008	bsr		drawTetrisBorder
putUpSprite:
00000009	4280011F	lix		r8,0x011F			; location 20,0
0000000a	D4000040	bsr		setScreenLocation_mmXGA
0000000b	428000E2	lix		r8,0xE2				; upper left corner
0000000c	D400003C	bsr		putChar_mmXGA
loopProg:
0000000d	D400004F	bsr		getChar_PS2
storeToScreen:
0000000e	D400003A	bsr		putChar_mmXGA
0000000f	C0FFFFFE	bra		loopProg

;
; drawBorder - draw the border around the FakeTis window
;

drawTetrisBorder:
00000010	A0408000	push	r8
00000011	A0409000	push	r9
00000012	42800014	lix		r8,0x0014			; location 20,0
00000013	D4000037	bsr		setScreenLocation_mmXGA
00000014	428000CC	lix		r8,0xCC				; upper left corner
00000015	D4000033	bsr		putChar_mmXGA
00000016	42900014	lix		r9,0x14				; 20 chars wide
anotherHorizTop:
00000017	42800083	lix		r8,0x83				; horizontal line
00000018	D4000030	bsr		putChar_mmXGA
00000019	23990001	subi	r9,r9,1
0000001a	C7FFFFFD	bnz		anotherHorizTop
0000001b	428000CD	lix		r8,0xCD				; upper right corner
0000001c	D400002C	bsr		putChar_mmXGA
; vertical left side
0000001d	4290001E	lix		r9,0x1E				; 30 rows high
0000001e	42800114	lix		r8,0x0114			; location 20,0
0000001f	D400002B	bsr		setScreenLocation_mmXGA
00000020	4280008C	lix		r8,0x8C				; vertical line
anotherLeftVert:
00000021	D4000027	bsr		putChar_mmXGA
00000022	2155003F	addi	PAR,PAR,0x3F
00000023	23990001	subi	r9,r9,1
00000024	C7FFFFFD	bnz		anotherLeftVert
; vertical right side
00000025	4290001E	lix		r9,0x1E				; 30 rows high
00000026	42800129	lix		r8,0x0129			; location 41,1
00000027	D4000023	bsr		setScreenLocation_mmXGA
00000028	4280008B	lix		r8,0x8B				; vertical line
anotherLeftVert2:
00000029	D400001F	bsr		putChar_mmXGA
0000002a	2155003F	addi	PAR,PAR,0x3F
0000002b	23990001	subi	r9,r9,1
0000002c	C7FFFFFD	bnz		anotherLeftVert2
; Draw bottom box
0000002d	42801F14	lix		r8,0x1F14			; location 20,0
0000002e	D400001C	bsr		setScreenLocation_mmXGA
0000002f	428000CB	lix		r8,0xCB				; lower left corner
00000030	D4000018	bsr		putChar_mmXGA
00000031	42900014	lix		r9,0x14				; 20 chars wide
anotherHorizBottom:
00000032	42800084	lix		r8,0x84				; horizontal line
00000033	D4000015	bsr		putChar_mmXGA
00000034	23990001	subi	r9,r9,1
00000035	C7FFFFFD	bnz		anotherHorizBottom
00000036	428000CE	lix		r8,0xCE				; upper right corner
00000037	D4000011	bsr		putChar_mmXGA

00000038	A1904000	pull	r9
00000039	A1804000	pull	r8
0000003a	A1704000	pull	PC

screenX:	.LONG	0x0
screenY:	.LONG	0x0
screenAdr:	.LONG	0x0
;
; clearScreen_XGA - Clear the screen routine
; Fills the screen with space characters
; Screen is memory mapped
; Screen is 64 columns by 32 rows = 2KB total space
;

clearScreen_mmXGA:
0000003b	A0405000	push	PAR
0000003c	A0409000	push	r9
0000003d	A0408000	push	r8
0000003e	42500000	lix 	par,0x0000	; start of screen character memory
0000003f	42800020	lix		r8,0x20		; fill with spaces
00000040	42900800	lix 	r9,0x800	; loopCount	(2K)
looper:
00000041	89508000	spbp 	r8			; put the character to the screen
00000042	23990001	subi 	r9,r9,1		; decrement character counter
00000043	C7FFFFFE	bnz		looper		; loop until complete
00000044	A1804000	pull	r8
00000045	A1904000	pull	r9
00000046	A1504000	pull	PAR
00000047	A1704000	pull	PC

;
; putChar_MemMapXGA - Put a character to the screen and increment the address
; r8 = Character to put to screen
; PAR = set to the current screen location
;

putChar_mmXGA:
00000048	89508000	spbp	r8			; write character to peripheral bus
00000049	A1704000	pull	PC

;
; setScreenLocation_XGA - Set PAR to a particular screen location
; Also sets the variables screenX and screenY
; r8 - screen location
;	d0-d7 = X coordinate
;	d8-d15 = Y coordinate
;

setScreenLocation_mmXGA:
0000004a	A0409000	push	r9
0000004b	33908000	sr8		r9,r8
0000004c	2B8800FF	andi	r8,r8,0x00ff
0000004d	42600010	lix		DAR,screenX.lower
0000004e	6D608000	sdlp	r8					; X location
0000004f	6D609000	sdlp	r9					; Y location
00000050	25990040	muli	r9,r9,0x40			; location is Y*63+X
00000051	6D609000	sdlp	r9					; Y location * 64
00000052	20598000	add		PAR,r9,r8
00000053	65605000	sdl		PAR					; Y location
00000054	A1904000	pull	r9
00000055	A1704000	pull	PC

;
; dumpCharSet_xxXGA
;

dumpCharSet_xxXGA:
00000056	42800000	lix		r8,0x0
nextCharDump:
00000057	D4FFFFF1	bsr		putChar_mmXGA
00000058	21880001	addi	r8,r8,1
00000059	39380100	cmpi	r8,0x100
0000005a	D2FFFFFD	bne		nextCharDump
0000005b	A1704000	pull 	PC
;--------------------------------------------------------------------
; ps2.asm - Functions to read the PS/2 keyboard
;
; Address	Function
; x0800 	Latched Keyboard Data
; x0801 	Latched Keyboard Status
; x0802 	Polled Keyboard Data
; x0803 	Polled Keyboard Status
;
; getChar_PS2
; returns character received in r8
;

getChar_PS2:
0000005c	A0405000	push	PAR
0000005d	42500801	lix		PAR,0x0801	; PS/2 Status
waitPS2RxStat:
0000005e	84805000	lpl		r8			; Read Status into r9
0000005f	2B880001	andi 	r8,r8,1
00000060	C3FFFFFE	bez 	waitPS2RxStat
getCharFromPS2:
00000061	42500800	lix 	PAR,0x0800
00000062	84805000	lpl		r8
whilePS2RxStat:
00000063	A1504000	pull	PAR
00000064	A1704000	pull	PC

; waitReadPS2_UART
; wait for character from either
;	the PS/2 keyboard or the UART serial
; r8 = read character

waitReadPS2_UART:
00000065	A0405000	push	PAR
checkCharFromPS2:
00000066	42500801	lix		PAR,0x0801	; PS/2 Status
00000067	84805000	lpl		r8			; Read Status
00000068	2B880001	andi	r8,r8,0x1	; =1 when char received
00000069	C3000004	bez 	checkUARTStat
0000006a	42500800	lix 	PAR,0x0800	; PS/2 Data
0000006b	84805000	lpl		r8
0000006c	C0000007	bra		gotPS2Char
checkUARTStat:
0000006d	42501800	lix		PAR,0x1800	; UART Status
0000006e	84805000	lpl		r8			; Read Status
0000006f	2B880001	andi 	r8,r8,0x1	; =1 when char received
00000070	C3FFFFF6	bez 	checkCharFromPS2
00000071	42501801	lix 	PAR,0x1801	; UART Data
00000072	84805000	lpl		r8
gotPS2Char:
00000073	A1504000	pull	PAR
00000074	A1704000	pull	PC

; checkForCharAndDiscard - Check for a character in UART or PS/2
; Discard the character received
; return whether char was present (1) or no char was present (0)

checkForCharAndDiscard:
00000075	A0405000	push	PAR
00000076	42500801	lix		PAR,0x0801	; PS/2 Status
00000077	84805000	lpl		r8			; Read Status
00000078	2B880001	andi	r8,r8,0x1	; =1 when char received
00000079	C3000005	bez 	checkUARTStat2
0000007a	42500800	lix 	PAR,0x0800	; PS/2 Data
0000007b	84805000	lpl		r8			; throw away char
0000007c	42800001	lix		r8,0x1
0000007d	C000000A	bra		gotChar
checkUARTStat2:
0000007e	42501800	lix		PAR,0x1800	; UART Status
0000007f	84805000	lpl		r8			; Read Status
00000080	2B880001	andi 	r8,r8,0x1	; =1 when char received
00000081	C3000005	bez 	noCharReceived
00000082	42501801	lix 	PAR,0x1801	; UART Data
00000083	84805000	lpl		r8
00000084	42800001	lix		r8,1
00000085	C0000002	bra		gotChar
noCharReceived:
00000086	42800000	lix		r8,0
gotChar:
00000087	A1504000	pull	PAR
00000088	A1704000	pull	PC

;
; waitCharPolled_PS2 - Check the polled character interface
; wait for a character
; return when a character is present
; returns character received in r8
;

waitCharPolled_PS2:
00000089	A0405000	push	PAR
0000008a	42500803	lix		PAR,0x0803	; PS/2 Status
waitPS2RxStatPolled:
0000008b	84805000	lpl		r8			; Read Status into r8
0000008c	2B880001	andi 	r8,r8,0x1
0000008d	C3FFFFFE	bez 	waitPS2RxStatPolled
getCharFromPS2Polled:
0000008e	42500802	lix 	PAR,0x0802
0000008f	84805000	lpl		r8
whilePS2RxStatPolled:
00000090	A1504000	pull	PAR
00000091	A1704000	pull	PC

;
; checkGetStat_PS2 - Checks the polling status
; Polled interface is active while the keyboard key is pressed
; returns
;	-1 if there is no character,
;	character if there is a character
;

checkGetStat_PS2:
00000092	A0405000	push	PAR
00000093	42500803	lix		PAR,0x0803	; PS/2 Status
00000094	84805000	lpl		r8			; Read Status into r8
00000095	2B880001	andi	r8,r8,0x1
00000096	C3000004	bez		charNotPresent
00000097	42500802	lix		PAR,0x0802
00000098	84805000	lpl		r8
00000099	C0000002	bra		gotCharIn
charNotPresent:
0000009a	20802000	add		r8,ZERO,MINUS1
gotCharIn:
0000009b	A1504000	pull	PAR
0000009c	A1704000	pull	PC
